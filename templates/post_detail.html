{% extends 'base.html' %}
{% load staticfiles %}
{% block  page_head %}
    <title>{{ post.title }}</title>
    <link rel="stylesheet" href="{% static 'My_blog/css/main.css' %}">
{% endblock %}

{% block page_content %}
    <div class="container">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    Post {{ message }}
                </div>
            {% endfor %}
        {% endif %}
        <div>
            <h1>
                {{ post.title }}
            </h1>
            <img class="mt-40" width="auto" height="300" src="{{ post.image.url }}" alt="">
            <p class="mt-40">
                {{ post.content }}
            </p>
            <p class="mt-40">
                {{ post.created_on }}
            </p>
        </div>
        <hr/>
        <div id="">
        <h4>Leave a comment:</h4>
        <form  class="commentForm" action="{% url 'comment_create_url' post.slug %}" method="post" data-url="{% url 'comment_create_url' post.slug %}">{% csrf_token %}
            <input type="text" name="content" id="commentContent">
            <input type="submit" value="Submit" class="btn btn-outline-success">
        </form>
        <div>
            {{ post.comments.count }} Comment{{ comments|pluralize }}
            {% for com in post.comments.all %}
                <blockquote id="commentsection" class="blockquote">
                    <p class="mb-0">{{ com.content }}
                        <small id="replyCount">( {{ com.reply.count }} reply)</small>
                    </p>
                    <footer class="blockquote-footer">by <cite title="Source Title">{{ com.user|capfirst }}</cite>
                        on {{ com.timestamp }}</footer>
                    <button onclick='myfunction({{ forloop.counter }})' class="reply_button btn btn-outline-primary"
                            type="button">Reply
                    </button>
                    <div class="hidden" id="{{ forloop.counter }}">
                        <form class="replyForm" action="{% url 'reply_create_url' post.slug com.pk %}"
                              method="post">{% csrf_token %}
                            <input type="text" name="content">
                            <input type="submit" value="Reply" class="btn btn-outline-success">
                        </form>
                    </div>

                    {% for reply in com.reply.all %}
                        <blockquote class="blockquote ml-50">
                            <p class="mb-0">{{ reply.content }}</p>
                            <footer class="blockquote-footer">by <cite
                                    title="Source Title">{{ reply.user|capfirst }}</cite>
                                on {{ reply.timestamp }}</footer>
                        </blockquote>

                    {% endfor %}

                </blockquote>

            {% endfor %}
        </div>
        </div>


        <a href="{{ post.get_update_url }}">
            <button class="btn btn-primary">Update this post</button>
        </a>
        <a class="" href="{% url 'post_new_delete' post.id %}">
            <button class="btn btn-primary">Delete this post</button>
        </a>
    </div>
     <script>
     $(document).ready(function(){
        var $myForm = $(".commentForm")
        $myForm.submit(function(event){
            event.preventDefault()
            var $formData = $(this).serialize()
            var $thisURL = $myForm.attr('data-url') || window.location.href
            $.ajax({
                method: "POST",
                url: $thisURL,
                data: $formData,
                success: handleFormSuccess,
                error: handleFormError,
            })
        });
        function displayTime() {
            var str = "";

            var currentTime = new Date()
            var months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
            var date = currentTime.getDate()
            var year = currentTime.getFullYear()
            var hours = currentTime.getHours()
            var minutes = currentTime.getMinutes()

            if (minutes < 10) {
                minutes = "0" + minutes
            }
            str += months[currentTime.getMonth()]+" " + date + ", "+ year +", "+ hours + ":" + minutes;
            if(hours > 11){
                str += " p.m."
            } else {
                str += " a.m."
            }
            return str;
        }

         function handleFormSuccess(data,textStatus, jqXHR){
            console.log(data)
            console.log(textStatus)
            console.log(jqXHR)
            $("#commentsection").prepend("<p class=\"mb-0\">"+$("#commentContent").val()+"<small>\( "+ $("#replyCount").val()+"  reply\)</small></p><footer class=\"blockquote-footer\">by <cite title=\"Source Title\">{{ request.user|capfirst }}</cite> on "+ displayTime() +"</footer> <button onclick='myfunction({{ forloop.counter }})' class=\"reply_button btn btn-outline-primary\"  type=\"button\">Reply  </button>");
            $myForm[0].reset();
         }
         function handleFormError(data, textStatus, errorThrown){
            console.log(data)
            console.log(textStatus)
            console.log(errorThrown)
         }
     });
</script>
   <script>
        function myfunction(commentId) {
            console.log(commentId)
            var replybtn = document.getElementById(commentId);

            if (replybtn.style.display == "block") {
                replybtn.style.display = "none";
            } else {
                replybtn.style.display = "block";
            }
        }
    </script>



{% endblock %}

